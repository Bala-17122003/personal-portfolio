<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelli-Grind Dashboard (Hover Preview)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        /* --- Base Setup & Variables --- */
        :root {
            --bg-dark-blue: #051021;
            --bg-mid-blue: #0b2633;
            --accent-cyan: #00eaff;
            --accent-blue: #0078ff;
            --accent-green: #00ff99;
            --accent-red: #ff5c5c;
            --accent-yellow: #f0f66e;
            --text-primary: #e6f7ff;
            --text-secondary: #9fd9ff;
            --border-color: rgba(0, 234, 255, 0.2);
            --card-bg: rgba(11, 38, 51, 0.5);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --shadow-glow-cyan: rgba(0, 234, 255, 0.15);
            --shadow-glow-red: rgba(255, 92, 92, 0.25);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        html, body { height: 100%; }
        body {
            background-color: var(--bg-dark-blue);
            background-image: linear-gradient(135deg, var(--bg-dark-blue) 0%, var(--bg-mid-blue) 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            padding: 1rem;
        }

        /* --- Background Effects --- */
        .glow-bg {
            position: fixed; left: -10%; top: -10%; width: 60vmax; height: 60vmax; border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 234, 255, 0.15), rgba(0, 120, 255, 0.05), transparent 70%);
            filter: blur(80px); z-index: 0; animation: float 12s ease-in-out infinite alternate;
        }
        @keyframes float { from { transform: translate(-5%, -5%) rotate(0deg); } to { transform: translate(5%, 5%) rotate(20deg); } }

        /* --- Base Layout --- */
        .shell { position: relative; z-index: 1; width: 100%; max-width: 1400px; margin: 28px auto; padding: 18px; }
        .card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(0,0,0,0.18); border-radius: 14px;
            padding: 18px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); margin-bottom: 1.5rem;
        }
        .hidden { display: none !important; }

        /* --- Components --- */
        .topbar { display: flex; justify-content: space-between; align-items: center; }
        .topbar h1 { color: var(--accent-cyan); letter-spacing: 1px; margin: 0; }
        
        .btn, .btn-logout, .btn-ticket {
            padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 600;
            color: var(--accent-cyan); background: transparent; border: 1px solid var(--accent-cyan);
            border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
        }
        .btn:hover, .btn-logout:hover { background: var(--accent-cyan); color: var(--bg-dark-blue); box-shadow: 0 0 15px var(--accent-cyan); }
        .btn-back { padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 600; color: var(--accent-cyan); border: 1px solid var(--accent-cyan); background: transparent; border-radius: 8px; cursor: pointer; }
        .btn-back:hover { background: var(--accent-cyan); color: var(--bg-dark-blue); }

        /* Ticket Button specific style */
        .btn-ticket {
            border-color: var(--accent-red); color: var(--accent-red); background: rgba(255, 92, 92, 0.1);
            margin-top: 10px; width: 100%;
        }
        .btn-ticket:hover { background: var(--accent-red); color: white; box-shadow: 0 0 15px var(--accent-red); }

        /* Login */
        .loginBox { width: 100%; max-width: 450px; margin: 10vh auto; border-radius: 14px; padding: 22px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); }
        .login-input { width: 100%; padding: 1rem; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); margin-bottom: 1rem; text-align: center; }
        .login-button { width: 100%; padding: 1rem; font-weight: 700; color: var(--bg-dark-blue); background-image: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue)); border: none; border-radius: 8px; cursor: pointer; }
        .login-error { color: var(--accent-red); margin-top: 1rem; text-align: center; }

        /* Grid & Tiles */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        
        .machine-tile {
            padding: 14px; border-radius: 10px; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.06));
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(0,0,0,0.22); transition: all 0.3s ease; cursor: pointer;
        }
        .machine-tile:hover { transform: translateY(-5px); border-color: var(--accent-cyan); box-shadow: 0 10px 30px var(--shadow-color), 0 0 20px var(--shadow-glow-cyan); }
        
        .tile-alert-red { border-color: var(--accent-red); animation: pulse-red 1.5s infinite; }
        .tile-alert-yellow { border-color: var(--accent-yellow); animation: pulse-yellow 1.5s infinite; }
        .tile-alert-grey { border-color: var(--text-secondary); opacity: 0.7; }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 var(--shadow-glow-red); } 50% { box-shadow: 0 0 25px var(--shadow-glow-red); } 100% { box-shadow: 0 0 0 var(--shadow-glow-red); } }
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 0 rgba(240,246,110,0.2); } 50% { box-shadow: 0 0 25px rgba(240,246,110,0.4); } 100% { box-shadow: 0 0 0 rgba(240,246,110,0.2); } }

        .kv { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: #9fd9ff; }
        .kv .big { font-weight: 800; font-size: 18px; color: var(--text-primary); }
        .status-bad { color: var(--accent-red); } .status-ok { color: var(--accent-green); } .status-warn { color: var(--accent-yellow); }

        .plant-tile { padding: 2.5rem; text-align: center; border: 1px solid rgba(0,0,0,0.22); background: rgba(255,255,255,0.06); border-radius: 10px; cursor: pointer; position: relative; }
        .plant-tile:hover { transform: translateY(-6px); border-color: var(--accent-cyan); }

        /* Detail View */
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        
        .alert-card {
            grid-column: 1 / 3; background: rgba(255, 92, 92, 0.1); border: 1px solid var(--accent-red);
            color: var(--accent-red); text-align: center; padding: 1.5rem; border-radius: 12px; display: none;
        }
        .alert-card.active { display: block; }

        .status-card-grid { grid-column: 1 / 3; display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .status-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; }
        .status-icon { font-size: 3rem; display: block; margin-bottom: 0.5rem; }
        .status-card .value { font-size: 1.75rem; font-weight: 700; }

        .graph-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; }
        .graph-card.full-width { grid-column: 1 / 3; }
        .graph-container { flex-grow: 1; min-height: 250px; }

        /* G-Code */
        .gcode-container { max-width: 800px; margin: 0 auto; }
        #dropZone { border: 2px dashed var(--border-color); padding: 40px; text-align: center; color: var(--text-secondary); background: rgba(0,0,0,0.2); cursor: pointer; margin-bottom: 1rem; }
        #dropZone.drag { border-color: var(--accent-cyan); background: var(--card-bg); }
        pre#codeOutput { background: #020617; padding: 16px; height: 280px; overflow-y: auto; font-family: monospace; border: 1px solid var(--border-color); }

        /* --- NEW: Hover Preview Tooltip Styles --- */
        #preview-tooltip {
            position: absolute;
            display: none;
            width: 320px;
            background: rgba(5, 16, 33, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.8), 0 0 20px rgba(0, 234, 255, 0.1);
            z-index: 9999;
            pointer-events: none; /* Allows mouse to move over it without flickering */
        }
        .preview-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 8px 0;
        }
        .preview-row:last-child { border-bottom: none; }
        .preview-machine { font-weight: bold; color: var(--text-primary); font-size: 0.95rem; }
        .preview-stat { font-size: 0.85rem; color: var(--text-secondary); }
        .preview-status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }

        /* Print */
        @media print {
            body { background: white; color: black; }
            .shell > *:not(.printable-area) { display: none; }
            .printable-area { display: block !important; width: 100%; box-shadow: none; border: none; }
            .card { border: 1px solid #ccc; color: black; box-shadow: none; }
            h1, h2, h3, .big, .value { color: black !important; }
            .btn, .btn-back, .btn-logout, #topControls { display: none; }
        }
    </style>
</head>
<body>
    <div class="glow-bg"></div>
    <div class="shell">

        <header id="app-header" class="card hidden">
            <div class="topbar">
                <div>
                    <h1 style="margin:0">Intelli-Grind</h1>
                    <div class="sub">Smart Grinding Dashboard</div>
                </div>
                <div id="topControls" style="display:flex; align-items:center; gap: 1rem;">
                    <div style="text-align: right;">
                        <div id="header-user-id" style="font-weight: 600;"></div>
                        <div id="header-user-role" style="font-size: 0.9rem; color: var(--accent-cyan);"></div>
                    </div>
                    <button id="logout-button" class="btn-logout">Logout</button>
                </div>
            </div>
        </header>

        <div id="loginCard" class="loginBox card">
            <div style="text-align:center; margin-bottom: 1.5rem;">
                <strong style="color:var(--accent-cyan); font-size: 2rem;">Welcome</strong>
                <div style="font-size:13px;color:#9fd9ff;margin-top:6px;">Enter your ID (e.g., WA, MA, PA)</div>
            </div>
            <input type="text" id="username-input" class="login-input" placeholder="Username">
            <input type="password" id="password-input" class="login-input" placeholder="Password">
            <button id="login-button" class="login-button">Login</button>
            <p id="login-error" class="login-error hidden">Invalid Username.</p>
        </div>

        <div id="workerDash" class="card hidden">
            <h2>Worker Dashboard</h2>
            <p class="sub" style="margin-bottom:1.5rem">Select a plant to view machines.</p>
            <div id="worker-plant-grid" class="grid"></div>
        </div>
        
        <div id="workerPlantViewDash" class="card hidden printable-area">
            <div class="detail-header">
                <h2 id="worker-plant-page-title" style="margin:0">Worker: Plant A</h2>
                <div class="no-print"> 
                    <button onclick="window.print()" class="btn">üì• Download Plant Report</button>
                    <button id="open-gcode-btn" class="btn">‚öôÔ∏è G/M Code</button>
                    <button id="back-to-worker-select" class="btn-back hidden">‚Üê Back</button>
                </div>
            </div>
            <div id="worker-machine-tile-grid" class="grid" style="margin-top:14px;"></div>
        </div>

        <div id="managerDash" class="card hidden printable-area">
            <div class="detail-header">
                <h2 id="manager-page-title" style="margin:0">Manager Dashboard</h2>
                <div class="no-print">
                    <button onclick="window.print()" class="btn">üì• Download Plant Report</button>
                    <button id="back-to-plant-select" class="btn-back hidden">‚Üê Back</button>
                </div>
            </div>
            <div id="manager-tile-grid" class="grid" style="margin-top:14px;"></div>
        </div>
        
        <div id="machineDetailDash" class="card hidden printable-area">
            <div class="detail-header">
                <h2 id="machine-detail-title" style="margin:0">Machine View</h2>
                <div class="no-print">
                    <button onclick="window.print()" class="btn">üì• Download Report</button>
                    <button id="back-to-previous-page" class="btn-back" style="margin-left:10px">‚Üê Back</button>
                </div>
            </div>
            
            <div class="detail-grid">
                <div id="machine-detail-alert-box" class="alert-card"></div>
                
                <div class="status-card-grid">
                    <div class="status-card">
                        <span class="status-icon">üì¶</span>
                        <span class="label">Workpiece (IR)</span>
                        <span id="detail-ir-status" class="value">--</span>
                    </div>
                    <div class="status-card">
                        <span class="status-icon">üìê</span>
                        <span class="label">Alignment</span>
                        <span id="detail-alignment-status" class="value">--</span>
                    </div>
                </div>

                <div class="graph-card">
                    <h3>Speed (RPM) - Ideal: 1500</h3>
                    <div class="graph-container"><canvas id="speed-chart"></canvas></div>
                </div>
                <div class="graph-card">
                    <h3>Vibration (m/s¬≤) - Max: 5.5</h3>
                    <div class="graph-container"><canvas id="vibration-chart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="plantDash" class="card hidden">
            <h2>Plant In-Charge Dashboard</h2>
            <p class="sub" style="margin-bottom:1.5rem">Hover to preview data. Click for details.</p>
            <div id="plant-in-charge-grid" class="grid" style="margin-top:12px;"></div>
        </div>
        
        <div id="gcodeGeneratorPage" class="card hidden">
            <div class="detail-header">
                <h2>G/M Code Generator</h2>
                <button id="back-to-worker-plant-view" class="btn-back">‚Üê Back</button>
            </div>
            <div class="gcode-container">
                <div id="dropZone">Drag & Drop CAD file (.stp / .stl)</div>
                <input type="file" id="fileInput" accept=".stp,.step,.stl" style="display:none;">
                <button id="generateBtn" class="btn" onclick="generateGCode()" disabled style="width:100%">Generate Code</button>
                <div id="outputSection" class="hidden">
                    <pre id="codeOutput" style="margin-top:1rem"></pre>
                </div>
            </div>
        </div>
        
        <div id="preview-tooltip"></div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // CONSTANTS
            const DATA_FETCH_INTERVAL = 2000;
            const ALL_MACHINES = [
                'Plant_A_01', 'Plant_A_02', 'Plant_A_03',
                'Plant_B_01', 'Plant_B_02', 'Plant_B_03',
                'Plant_C_01', 'Plant_C_02', 'Plant_C_03'
            ];
            const PLANTS = ['A', 'B', 'C'];
            
            let appState = { currentPage: 'login', currentUser: null, currentRole: null, currentPlant: null, currentMachine: null };
            let globalDataStore = {};
            let historicalDataStore = {};
            let dataFetchInterval = null;
            let chartObjects = {};

            // DOM Elements
            const pages = {
                login: document.getElementById('loginCard'),
                worker: document.getElementById('workerDash'),
                workerPlantView: document.getElementById('workerPlantViewDash'),
                manager: document.getElementById('managerDash'),
                machineDetail: document.getElementById('machineDetailDash'),
                plantInCharge: document.getElementById('plantDash'),
                gcodeGenerator: document.getElementById('gcodeGeneratorPage')
            };
            
            const previewTooltip = document.getElementById('preview-tooltip');

            // --- DATA GENERATION ---
            function generateRandomMachineData(machineId) {
                const irPresent = Math.random() < 0.85 ? 1 : 0;
                let alignment = 1;
                let speed = 0;
                let vib = 0;
                let status = { code: "OFFLINE", msg: "Offline", color: "grey" };

                if (irPresent === 1) {
                    const rand = Math.random();
                    speed = 1495 + Math.floor(Math.random() * 10); 
                    vib = (Math.random() * 2.5).toFixed(2); 
                    status = { code: "RUNNING", msg: "Optimal", color: "green" };
                    alignment = 1;

                    if (rand > 0.7 && rand < 0.9) {
                        speed = Math.random() > 0.5 ? 1580 : 1420; 
                        vib = (3.0 + Math.random()).toFixed(2);
                        status = { code: "ERROR", msg: "RPM Alert", color: "red" };
                    } else if (rand >= 0.9) {
                        speed = 1500; 
                        vib = (5.6 + Math.random() * 2).toFixed(2);
                        status = { code: "ERROR", msg: "High Vib", color: "red" };
                        alignment = 0;
                    }
                }

                return {
                    id: machineId,
                    sensors: { speed: speed, vib: parseFloat(vib), ir: irPresent, align: alignment },
                    status: status
                };
            }

            function updateSimulation() {
                ALL_MACHINES.forEach(id => {
                    globalDataStore[id] = generateRandomMachineData(id);
                    if (!historicalDataStore[id]) historicalDataStore[id] = [];
                    historicalDataStore[id].push({ time: new Date(), sensors: globalDataStore[id].sensors });
                    if (historicalDataStore[id].length > 20) historicalDataStore[id].shift();
                });
            }

            function startDataFetcher() {
                if (dataFetchInterval) clearInterval(dataFetchInterval);
                updateSimulation();
                dataFetchInterval = setInterval(() => {
                    updateSimulation();
                    if (appState.currentPage !== 'gcodeGenerator') renderCurrentPage();
                    // Also update tooltip if it is visible
                    if (previewTooltip.style.display === 'block' && currentHoverPlant) {
                        updatePreviewContent(currentHoverPlant);
                    }
                }, DATA_FETCH_INTERVAL);
            }

            // --- UI LOGIC ---
            function renderCurrentPage() {
                switch (appState.currentPage) {
                    case 'workerPlantView': renderPlantView('worker-machine-tile-grid'); break;
                    case 'manager': renderPlantView('manager-tile-grid'); break;
                    case 'machineDetail': renderMachineDetail(); break;
                }
            }

            function renderPlantView(gridId) {
                const grid = document.getElementById(gridId);
                grid.innerHTML = '';
                const plantPrefix = `Plant_${appState.currentPlant}`;
                const machines = ALL_MACHINES.filter(m => m.startsWith(plantPrefix));

                machines.forEach(mId => {
                    const data = globalDataStore[mId];
                    // Guard against missing data during init
                    if(!data) return;
                    
                    const div = document.createElement('div');
                    div.className = `machine-tile tile-alert-${data.status.color}`;
                    div.onclick = () => { appState.currentMachine = mId; showPage('machineDetail'); };
                    
                    let statusClass = data.status.color === 'red' ? 'status-bad' : (data.status.color === 'yellow' ? 'status-warn' : 'status-ok');
                    
                    div.innerHTML = `
                        <h3>${mId}</h3>
                        <div class="kv"><div>Status</div><div class="big ${statusClass}">${data.status.msg}</div></div>
                        <div class="kv"><div>RPM</div><div class="big">${data.sensors.speed}</div></div>
                        <div class="kv"><div>Vibration</div><div class="big">${data.sensors.vib}</div></div>
                    `;
                    grid.appendChild(div);
                });
                
                if(appState.currentPage === 'workerPlantView') document.getElementById('worker-plant-page-title').textContent = `Worker: Plant ${appState.currentPlant}`;
                if(appState.currentPage === 'manager') document.getElementById('manager-page-title').textContent = `Manager: Plant ${appState.currentPlant}`;
            }

            function renderMachineDetail() {
                const mId = appState.currentMachine;
                const data = globalDataStore[mId];
                const history = historicalDataStore[mId];
                if(!data) return;

                document.getElementById('machine-detail-title').textContent = `Machine: ${mId}`;

                const alertBox = document.getElementById('machine-detail-alert-box');
                const isRpmBad = (data.sensors.ir === 1) && (data.sensors.speed < 1490 || data.sensors.speed > 1510);
                const isVibBad = data.sensors.vib > 5.5;

                if (isRpmBad || isVibBad) {
                    alertBox.classList.add('active');
                    let msg = "";
                    if (isRpmBad) msg += "RPM Fluctuation Detected (Ideal: 1500). ";
                    if (isVibBad) msg += "Vibration Critical (> 5.5m/s¬≤).";
                    alertBox.innerHTML = `<strong style="font-size:1.4rem">‚ö†Ô∏è ALERT</strong><br>${msg} <button class="btn btn-ticket" onclick="alert('Ticket #9928 raised!')">üé´ Raise Ticket</button>`;
                } else {
                    alertBox.classList.remove('active');
                }

                document.getElementById('detail-ir-status').textContent = data.sensors.ir ? "PRESENT" : "NOT PRESENT";
                document.getElementById('detail-ir-status').className = data.sensors.ir ? "value status-ok" : "value status-off";

                const alEl = document.getElementById('detail-alignment-status');
                if (data.sensors.ir) {
                    alEl.textContent = data.sensors.align ? "OK" : "MISALIGNMENT";
                    alEl.className = data.sensors.align ? "value status-ok" : "value status-bad";
                } else {
                    alEl.textContent = "OFF";
                    alEl.className = "value status-off";
                }

                if(history) {
                    const labels = history.map(h => h.time);
                    const speeds = history.map(h => h.sensors.speed);
                    const vibs = history.map(h => h.sensors.vib);
                    drawChart('speed-chart', 'Speed', labels, speeds, '#00eaff');
                    drawChart('vibration-chart', 'Vibration', labels, vibs, '#f0f66e');
                }
            }

            function drawChart(id, label, labels, data, color) {
                const ctx = document.getElementById(id).getContext('2d');
                if (chartObjects[id]) chartObjects[id].destroy();
                chartObjects[id] = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label, data, borderColor: color, borderWidth: 2, pointRadius: 0 }] },
                    options: { 
                        responsive: true, maintainAspectRatio: false, 
                        scales: { x: { type: 'time', time: { unit: 'second', displayFormats:{second:'HH:mm:ss'} }, grid:{color:'rgba(255,255,255,0.1)'} }, y: { grid:{color:'rgba(255,255,255,0.1)'} } },
                        plugins: { legend: {display: false} }, animation: false
                    }
                });
            }

            // --- HOVER PREVIEW LOGIC ---
            let currentHoverPlant = null;

            function showPreview(e, plantId) {
                currentHoverPlant = plantId;
                updatePreviewContent(plantId);
                previewTooltip.style.display = 'block';
                movePreview(e);
            }

            function updatePreviewContent(plantId) {
                const machines = ALL_MACHINES.filter(m => m.startsWith(`Plant_${plantId}`));
                let html = `<h3 style="margin:0 0 10px 0; color:var(--accent-cyan); font-size:1.1rem; border-bottom:1px solid var(--accent-cyan); padding-bottom:5px;">Plant ${plantId} Live Status</h3>`;
                
                machines.forEach(mId => {
                    const data = globalDataStore[mId];
                    if(!data) return;
                    const color = data.status.color === 'red' ? '#ff5c5c' : (data.status.color === 'yellow' ? '#f0f66e' : (data.status.color === 'grey' ? '#9fd9ff' : '#00ff99'));
                    
                    html += `
                    <div class="preview-row">
                        <div>
                            <span class="preview-status-dot" style="background-color:${color}"></span>
                            <span class="preview-machine">${mId}</span>
                        </div>
                        <div class="preview-stat">
                            ${data.sensors.speed} RPM | ${data.sensors.vib} m/s¬≤
                        </div>
                    </div>`;
                });
                previewTooltip.innerHTML = html;
            }

            function movePreview(e) {
                const xOffset = 20;
                const yOffset = 20;
                // Prevent going off screen right
                let left = e.pageX + xOffset;
                if (left + 340 > window.innerWidth) left = e.pageX - 340;
                
                previewTooltip.style.left = left + 'px';
                previewTooltip.style.top = (e.pageY + yOffset) + 'px';
            }

            function hidePreview() {
                previewTooltip.style.display = 'none';
                currentHoverPlant = null;
            }

            // --- Navigation ---
            window.showPage = (pageId) => {
                Object.values(pages).forEach(p => p.classList.add('hidden'));
                pages[pageId].classList.remove('hidden');
                document.getElementById('app-header').classList.toggle('hidden', pageId === 'login');
                appState.currentPage = pageId;
                
                if(pageId === 'workerPlantView') document.getElementById('back-to-worker-select').classList.remove('hidden');
                if(pageId === 'manager') document.getElementById('back-to-plant-select').classList.toggle('hidden', appState.currentRole !== 'Plant In-Charge');

                renderCurrentPage();
            };

            // Login Handler
            document.getElementById('login-button').addEventListener('click', () => {
                const user = document.getElementById('username-input').value.trim().toUpperCase();
                let role = null, plant = null, page = 'worker';

                if (user.startsWith('W')) { role = 'Worker'; plant = user[1]; page = 'workerPlantView'; }
                else if (user.startsWith('M')) { role = 'Manager'; plant = user[1]; page = 'manager'; }
                else if (user.startsWith('P')) { role = 'Plant In-Charge'; page = 'plantInCharge'; }

                if ((role && ['A','B','C'].includes(plant)) || role === 'Plant In-Charge') {
                    appState = { ...appState, currentUser: user, currentRole: role, currentPlant: plant };
                    document.getElementById('header-user-id').textContent = user;
                    document.getElementById('header-user-role').textContent = role;
                    document.getElementById('login-error').classList.add('hidden');
                    
                    if(role === 'Plant In-Charge') renderPlantList('plant-in-charge-grid');
                    else if(role === 'Worker') renderPlantList('worker-plant-grid'); 
                    
                    showPage(page);
                    startDataFetcher();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                }
            });

            document.getElementById('logout-button').onclick = () => { clearInterval(dataFetchInterval); showPage('login'); document.getElementById('username-input').value = ''; };
            document.getElementById('back-to-worker-select').onclick = () => showPage('worker');
            document.getElementById('back-to-plant-select').onclick = () => showPage('plantInCharge');
            document.getElementById('back-to-previous-page').onclick = () => showPage(appState.currentRole === 'Worker' ? 'workerPlantView' : 'manager');

            // Plant Selection Rendering with Hover Events
            function renderPlantList(gridId) {
                const grid = document.getElementById(gridId);
                grid.innerHTML = '';
                PLANTS.forEach(p => {
                    const d = document.createElement('div');
                    d.className = 'plant-tile';
                    d.innerHTML = `<h3>Plant ${p}</h3><div style="color:#9fd9ff">3 machines</div>`;
                    
                    // Original Click
                    d.onclick = () => { 
                        appState.currentPlant = p; 
                        showPage(appState.currentRole === 'Plant In-Charge' ? 'manager' : 'workerPlantView'); 
                    };

                    // New Hover Logic (Only active for P-User essentially, but safe for all)
                    d.addEventListener('mouseenter', (e) => showPreview(e, p));
                    d.addEventListener('mousemove', movePreview);
                    d.addEventListener('mouseleave', hidePreview);

                    grid.appendChild(d);
                });
            }
            
            // G-Code
            document.getElementById('open-gcode-btn').onclick = () => showPage('gcodeGenerator');
            document.getElementById('back-to-worker-plant-view').onclick = () => showPage('workerPlantView');
            window.generateGCode = () => {
                document.getElementById('outputSection').classList.remove('hidden');
                document.getElementById('codeOutput').textContent = "Generating Optimized Path...\nDone.\n\nN10 G21 G90\nN20 G28 Z0\nN30 T01 M06\nN40 S1500 M03\nN50 G00 X0 Y0\nN60 G01 Z-5 F200\n... [Simulation]";
            }
            const dz = document.getElementById('dropZone');
            dz.onclick = () => document.getElementById('fileInput').click();
            document.getElementById('fileInput').onchange = () => { dz.innerText = "File Loaded"; document.getElementById('generateBtn').disabled = false; };
        });
    </script>
</body>
</html>
